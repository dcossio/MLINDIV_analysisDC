---
title: "Mediation Analysis"
author: "Daniela Cossio"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
    html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    classoption:
    - twocolumn
---

```{r adding libraries,echo=FALSE, results='hide',message=FALSE}
library(ggplot2)
#(plyr)
library(tidyverse)
# library(dplyr)
# library(tidyr)
library(stringr)
library(kableExtra)
# library(data.table)
# library(network)
# library(tidygraph)
# library(ggraph)
# library(igraph)
# library(networkD3)
# library(CINNA)
# library(umap)
# library(plotly)
#library(factoextra)
#library(lsr)
# library(car)
library(ggpubr)
#library(entropy)
#library(ds4psy)
# library(pROC)
#library(devtools)
#library(BRRR)
#library(stats)
#library(afex)
library(knitr)
library(janitor)
library(car)
library(ggiraph)
library(ggiraphExtra)
library(moonBook)
library(nationalparkcolors)
library(gridExtra)
library(markdown)
library(psych)
```



```{css, echo=FALSE}
TOC {
  color: #F6B2DB;
  font-family: Arial;
  font-size: "16px"; 
  border-color: #F6B2DB;
}

h1.title {
  color: black ;
  font-family: Arial;
  font-size: "72px";
  padding: "10px 0";
  background-color: #F6B2DB ;
  text-align: center;
}

h4.date {
  color: black ;
  font-family: Arial;
  font-size: "34px";
  text-align: center;
}

h4.author {
  color: black;
  font-size: "34px";
  font-family: Arial;
  text-align: center;
}


h1,h2, h3, h4, h5 ,h6 {
  text-align: center;
  font-family: Arial;
  
}

body, p, h2{
  color: black; 
  font-family: Arial;
}

hr {
  height:5px;
  border-width:0;
  background-color: black ;
}



```



```{r functions, echo=FALSE, results='hide',message=FALSE}

ReadingCSVFunc <- function(pathname){
  
  read.delim(paste0(working_dir, pathname), header=FALSE,sep = "\t")
  
}

CleanInput <- function(DF){
  

  DF <- DF %>% 
      remove_empty("cols") %>% 
        filter(V1 %in% rows2grab) %>% 
          t() %>% 
            `colnames<-`(rows2grab) %>% 
                `[`(-c(1),) %>% 
                    as.data.frame()
  return(DF)
}


Extract_raw_values <- function(DF,Metric) {
  # Purpose of this function is to clean the data without me having to copy and paste everything later. 
  
  # Data = raw unclean dataframe we want to clean up 
  # Metric will be either MD or QA
  # sex is either male or female
 
  
  # Let's read in our data frame 
  
  # grab  ROIcolumn names 
  colNames <- DF  %>% remove_empty("cols") %>%
  filter(V1 == "Tract Name") %>% t() %>% `[`(-1) 
  
  
  subinfo <- sub_info  %>% select(c("subject_id", "sex", "age_scan_years", "maze_accuracy_pct")) 
 
  # Let's grab our values 
  if (Metric == "MD"){
    Values <- DF %>% remove_empty("cols") %>% 
     filter(str_detect(V1, c("mean_md"))) %>%
   `colnames<-`(c("Subjects",colNames)) 
  }
  else{
    Values <- DF %>%
     remove_empty("cols") %>%
      filter(str_detect(V1, c("mean_qa"))) %>% 
  `colnames<-`(c("Subjects",colNames)) %>% filter(!str_detect(Subjects, c("sub-369"))) 

  }
  
  # now let's put this together 
  ConvToNum <-  apply(Values[,2:length(Values)],2, as.numeric)
  Values[,2:length(Values)] <- ConvToNum
  
  cleanedDF <- cbind(subinfo,Values) %>% na.omit() %>% select(-c("Subjects"))
  
  return (cleanedDF)
}


TableOutput <- function(df){
  knitr::kable(df, row.names=F) %>% 
  kable_styling(bootstrap_options =  c("striped", "hover", "condensed")) %>% 
  scroll_box(width = "800px", height = "300px") 
}



```

# Reading in and prepping our data 

```{r reading in our CSVs, echo=FALSE, results='hide',message=FALSE}
working_dir <- "/Users/danielacossio/Documents/Chrastil_Lab/Projects/SNAG/DSI_rerun_data/DSP/"

rows2grab <- c("Tract Name", "number of tracts","mean length(mm)","diameter(mm)", "volume(mm^3)")

All_sub_info <- read.csv("/Users/danielacossio/Documents/Chrastil_Lab/Projects/SNAG/sub_info_sheets/SNAG_Behavior.csv") # This is a sheet that has all of the subjects with at least one usable behavior task (Loop, maze, dsp)

DSP_DSI_DF <- read.csv("/Users/danielacossio/Documents/Chrastil_Lab/Projects/SNAG/sub_info_sheets/SNAG_DSP_scans.csv") %>% filter(!is.na(subject_id)) # This is from the main subject sheet and includes all subjects that have a dsp score AND should have a scan with them
```

Complete Subject Database

```{r}
TableOutput(All_sub_info)

```


# Methods and approach

# Thought process
I am doing a mediation analysis to understand the relation ship between white matter, hormones, and performance on the dual solution paradigm.

From shuying's data, DSP is associated with estradial. Increased solution index is associated with increased solution index.

MD is negatively associated with Solution Index such that increased MD in the fornix is associated with less shortcuts. Essentially lower white matter integrity in fornix is associated with lower performance.

Hypothesis for mediation is that greater estradiol is driving the relationship in which greater integrity in the fornix for greater solution index. 


X= Mean diffusivity in fornix  
Y= greater SI on DSP task  
M= Estradiol  


## Data Cleaning and organizing

### Step 1: read in the raw data

```{r,message=FALSE}

# This is a data frame which cotains a folder for each subject with 2 text files 
path2data <- ("/Users/danielacossio/Documents/Chrastil_Lab/Projects/SNAG/mediation_test_data/data_from_Midlife_20230103")

# List of all subject directories
subfiles <- list.dirs("/Users/danielacossio/Documents/Chrastil_Lab/Projects/SNAG/mediation_test_data/data_from_Midlife_20230103", full.names = FALSE,recursive = FALSE) # all of the data extracted from dsi 

# create an empty dataframe to loop into
fornix_output_df <-  data.frame(matrix(ncol = 5, nrow = 0)) %>% `colnames<-`(c("subjects","QA_L_fornix","QA_R_fornix","MD_L_fornix","MD_R_fornix"))

# creating a loop to go into each sub dir. read in each txt file and extract the 
for(file in 1:length((subfiles))){

  
  # creating an empty single row dataframe
  empty_loop_df <- data.frame(matrix(ncol = 5, nrow = 1))  %>% `colnames<-`(c("subjects","QA_L_fornix","QA_R_fornix","MD_L_fornix","MD_R_fornix"))
  
  # inputting the subject id
  empty_loop_df$subjects <- str_remove(subfiles[file],"sub-")
  
  
  # Let's do a quick folder check to make sure it's not empty 
  
  
  if(file.size(paste0(path2data,"/",subfiles[file])) < 128) next
  
  #grabbing all the left and right variables 
  L_fornix <- read_delim(paste0(path2data,"/",subfiles[file],"/",subfiles[file],"_space-T1w_desc-preproc_dwi.ProjectionBasalGanglia_FornixL.stat.txt"),col_names = FALSE) %>% filter(X1 %in% c("qa","md"))
  
  R_fornix <- read_delim(paste0(path2data,"/",subfiles[file],"/",subfiles[file],"_space-T1w_desc-preproc_dwi.ProjectionBasalGanglia_FornixR.stat.txt"),col_names = FALSE) %>% filter(X1 %in% c("qa","md"))
  
  # Putting them into out dataframe
  #Grab all QA values
  empty_loop_df$QA_L_fornix <- L_fornix$X2[1] # row 1 is QA
  empty_loop_df$QA_R_fornix <- R_fornix$X2[1]
    
    
  empty_loop_df$MD_L_fornix <- L_fornix$X2[2] # row 2 is MD
  empty_loop_df$MD_R_fornix <- R_fornix$X2[2]
  
  fornix_output_df <- rbind(fornix_output_df,empty_loop_df)
}


# now we have to grab the information from sub info and combine but we need to make sure we're grabbing all the correct subjects from each dataframe. Something to note is that this final fornix data frame is based off of scans and includes some people who do not have a DSP score

altered_sub_info <- DSP_DSI_DF %>% filter(subject_id %in% c(fornix_output_df$subjects)) 

fornix_output_df <- fornix_output_df %>%  filter(subjects %in% c(DSP_DSI_DF$subject_id))


clean_DF <- cbind(altered_sub_info,fornix_output_df)

clean_DF$QA_Whole_Fornix <- rowMeans(clean_DF[,c("QA_L_fornix","QA_R_fornix")])

clean_DF$MD_Whole_Fornix <- rowMeans(clean_DF[,c("MD_L_fornix","MD_R_fornix")])
```


### Step 2: Normality check and visualization of data {.tabset}

#### Using ALl DSP subjects {.tabset}

##### DSP

WE can see that the DSP values are not normally distributed when looking at all the subject and when looking at just women only.

Here I am plotting the data for all dsp(regardless of scan). There are a total of 74 subjects here. Shuying had about 76 subjects and idk where the discrepancy is coming from. You can see there is a right hand skew on this data and it does not pass normality test (p-value = 9.242e-05)
```{r}
data_dsp <- All_sub_info %>% filter(dsp_useable == "Yes") %>% filter(subject_id < 500) # dataframe with all subjects that have usable DSP

ggplot(data_dsp, aes(x=dsp_si_true_pct)) +
   geom_bar(width = 0.1)
shapiro.test(data_dsp$dsp_si_true_pct)


TableOutput(describe(data_dsp))
```


<br>

Now here i want to look at the skews for males and females separately. There's a bit of a skew and it does not pass normality (p-value = 0.001114)

```{r}
f_data_dsp <- data_dsp %>% filter(sex == "Female") # Women only

ggplot(f_data_dsp, aes(x=dsp_si_true_pct)) +
   geom_bar(width = 0.1)
shapiro.test(f_data_dsp$dsp_si_true_pct)

```


Now let's look at males. Here there is a bit of a skew and it failes normality (p-value = 0.02375)

```{r}
#check visualization and normality of all dsp data not just the scans ones
  
m_data_dsp<- data_dsp %>% filter(sex=="Male") # Men only
  

ggplot(m_data_dsp, aes(x=dsp_si_true_pct)) +
   geom_bar(width = 0.1)
shapiro.test(m_data_dsp$dsp_si_true_pct)

```


So can we then try and normalize the data?

Here let's normaliza using log transform. Log transform does change the skew but also some numbers (0) are now labeled as inf. Meaning we should do something to make those turn into an acutal number  perhaps 0.0001?

```{r}

ggplot(data_dsp, aes(x=log(dsp_si_true_pct))) +
   geom_bar(width = 0.1)

#I think things need to be changed from 0 to 0. 001
shapiro.test(log(data_dsp$dsp_si_true_pct)) # this comes out as Na but shuyings did not so idk why that's happening.


```


LEt's try a square root transform 

The square root transform normalizes it a bit more but it still failed normality test. 
```{r}

ggplot(data_dsp, aes(x=sqrt(dsp_si_true_pct))) +
   geom_bar(width = 0.1)

shapiro.test(sqrt(data_dsp$dsp_si_true_pct)) # 

```


LEt's look at a transformation of all womens data

log transform: again NA for normality test but does appear to fix it a bit
```{r}

ggplot(f_data_dsp, aes(x=log(dsp_si_true_pct))) +
   geom_bar(width = 0.1)

#I think things need to be changed from 0 to 0. 001
shapiro.test(log(f_data_dsp$dsp_si_true_pct)) # this comes out as Na but shuyings did not so idk why that's happening.


```

Square Transform: again still skewefd and fails normality. 

```{r}

ggplot(f_data_dsp, aes(x=sqrt(dsp_si_true_pct))) +
   geom_bar(width = 0.1)


shapiro.test(sqrt(f_data_dsp$dsp_si_true_pct)) #


```


##### Estradiol 

Here let's look at estradial skews for all women who have a dsp score. It does not pass normality 4.352e-07
```{r}

ggplot(f_data_dsp, aes(x=estradiol_spatial_pg_ml)) +
   geom_bar(width = 10)
shapiro.test(f_data_dsp$estradiol_spatial_pg_ml)


```

Can we tranform Estradial . This still fails normality but just barely p-value = 0.03153
```{r}

ggplot(f_data_dsp, aes(x=log(estradiol_spatial_pg_ml))) +
   geom_freqpoly(width = 10)
shapiro.test(log(f_data_dsp$estradiol_spatial_pg_ml))


```

Square root?This still fails normality but just barely p-value = 0.002019
```{r}

ggplot(f_data_dsp, aes(x=sqrt(estradiol_spatial_pg_ml))) +
   geom_freqpoly(width = 10)
shapiro.test(sqrt(f_data_dsp$estradiol_spatial_pg_ml))


```

<br>

##### FSH 

FSh also has a skew and fails normality p-value = 0.0008676

```{r}

ggplot(f_data_dsp, aes(x=fsh_spatial_miu_ml)) +
   geom_bar(width = 10)
shapiro.test(f_data_dsp$fsh_spatial_miu_ml)


```
<br> 

Can we tranform FSH . This still fails normality p-value = 0.0008156
```{r}

ggplot(f_data_dsp, aes(x=log(fsh_spatial_miu_ml))) +
   geom_freqpoly(width = 10)
shapiro.test(log(f_data_dsp$fsh_spatial_miu_ml))


```

Square root?This still fails normality p-value = 0.003438.
```{r}

ggplot(f_data_dsp, aes(x=sqrt(fsh_spatial_miu_ml))) +
   geom_freqpoly(width = 10)
shapiro.test(sqrt(f_data_dsp$fsh_spatial_miu_ml))


```


No good way to normalize this data so far

<br>
<br>

#### Using ALl subjcts with DSP and a fornix score  {.tabset .tabset-pills}

So just like above, this data set is also right skewed and fails normality 0.005673

```{r}

ggplot(clean_DF, aes(x=clean_DF$dsp_si_true_pct)) +
   geom_bar(width = 0.1)
shapiro.test(clean_DF$dsp_si_true_pct)



```

<br>

Again, for women there is a skew but barely fails normality p=0.02
```{r}

all_women_clean_df <- clean_DF %>% filter(sex=="Female")

ggplot(all_women_clean_df, aes(x=dsp_si_true_pct)) +
   geom_bar(width = 0.1)

shapiro.test(all_women_clean_df$dsp_si_true_pct)

```

So let's try transforming this

Log transform all subjects. This visually looks much less skewed but also has some infinate numbers so we can check normality. Might need to change the inf to 0?
```{r}

ggplot(clean_DF, aes(x=log(clean_DF$dsp_si_true_pct))) +
   geom_bar(width = 0.1)
shapiro.test(log(clean_DF$dsp_si_true_pct))

```

Just to check, sqrt. Fails normality because of the 0s P = 0.001583

```{r}

ggplot(clean_DF, aes(x=sqrt(clean_DF$dsp_si_true_pct))) +
   geom_bar(width = 0.1)
shapiro.test(sqrt(clean_DF$dsp_si_true_pct))

```


LEt's look at the females

Log transform all subjects. This visually looks much less skewed but also has some infinate numbers so we can check normality. Might need to change the inf to 0?
```{r}

ggplot(all_women_clean_df, aes(x=log(all_women_clean_df$dsp_si_true_pct))) +
   geom_bar(width = 0.1)
shapiro.test(log(all_women_clean_df$dsp_si_true_pct))

```

Just to check, sqrt. Fails normality because of the 0s P = 0.002123

```{r}

ggplot(all_women_clean_df, aes(x=sqrt(all_women_clean_df$dsp_si_true_pct))) +
   geom_bar(width = 0.1)
shapiro.test(sqrt(all_women_clean_df$dsp_si_true_pct))

```

### step 2.5: Can we replicate shuyings findings?

Shuying had: 
We have p=0.014

```{r}

cor.test(all_women_clean_df$estradiol_scan_pg_ml,
         all_women_clean_df$dsp_si_true_pct,
         conf.level = 0.95,
         method = "spearman")
```



### Step 3: Prepare the mediation by grabbing our final df. Removing any rows that are NA 

```{r}
mediation_estradiol_DF <- clean_DF %>% select(subject_id,sex,age_spatial_years,repo_status,dsp_si_true_pct,estradiol_scan_pg_ml,progesterone_scan_ng_ml,testosterone_scan_ng_dl,fsh_scan_miu_ml,QA_L_fornix,QA_R_fornix,MD_L_fornix,MD_R_fornix, MD_Whole_Fornix, QA_Whole_Fornix) %>% filter(!is.na(dsp_si_true_pct )) %>% filter(!is.na(estradiol_scan_pg_ml)) %>% filter(sex== "Female")
```

```{r}
mediation_test_DF <- clean_DF %>% select(subject_id,sex,age_spatial_years,repo_status,dsp_si_true_pct,estradiol_scan_pg_ml,progesterone_scan_ng_ml,testosterone_scan_ng_dl,fsh_scan_miu_ml,QA_L_fornix,QA_R_fornix,MD_L_fornix,MD_R_fornix) %>% filter(!is.na(dsp_si_true_pct )) %>% filter(!is.na(testosterone_scan_ng_dl)) %>% filter(sex== "Female")

```

```{r}
mediation_FSH_DF <- clean_DF %>% select(subject_id,sex,age_spatial_years,repo_status,dsp_si_true_pct,estradiol_scan_pg_ml,progesterone_scan_ng_ml,testosterone_scan_ng_dl,fsh_scan_miu_ml,QA_L_fornix,QA_R_fornix,MD_L_fornix,MD_R_fornix) %>% filter(!is.na(dsp_si_true_pct )) %>% filter(!is.na(fsh_scan_miu_ml)) %>% filter(sex== "Female")
```



## Mediation

## Estradiol
Step 1 of mediation is to complete the first correlation in which X= L_fornix and Y = DSP

```{r}
model.1 <- lm(MD_Whole_Fornix ~ dsp_si_true_pct, mediation_estradiol_DF)
summary(model.1)
```

Step 2 of mediation is to complete the next correlation in which X= hormones and Y = DSP

```{r}
model.2 <- lm(estradiol_scan_pg_ml ~ dsp_si_true_pct, mediation_estradiol_DF)
summary(model.2)
```


```{r}
model.2 <- lm(estradiol_scan_pg_ml ~ MD_Whole_Fornix, mediation_estradiol_DF)
summary(model.2)
```




# Summarized Results

