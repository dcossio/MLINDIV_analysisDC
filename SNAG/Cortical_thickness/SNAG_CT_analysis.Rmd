---
title: "SNAG Cortical Thickness"
author: "Daniela Cossio"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
   html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    classoption:
    - twocolumn
---

```{css, echo=FALSE}
TOC {
  color: #F6B2DB;
  font-family: Times;
  font-size: "16px"; 
  border-color: #F6B2DB;
}

h1.title {
  color: black ;
  font-family: Times;
  font-size: "72px";
  padding: "10px 0";
  background-color: #F6B2DB ;
  text-align: center;
}

h4.date {
  color: black ;
  font-family: Times;
  font-size: "34px";
  text-align: center;
}

h4.author {
  color: black;
  font-size: "34px";
  font-family: Times;
  text-align: center;
}


h1,h2, h3, h4, h5 ,h6 {
  text-align: center;
  font-family: Times;
  
}

body, p, h2{
  color: black; 
  font-family: Times;
}

hr {
  height:5px;
  border-width:0;
  background-color: black ;
}



```

```{r set-options, echo=FALSE, cache=FALSE}
options(width = 100)
```

```{r adding libraries,echo=FALSE, results='hide',message=FALSE}
library(ggplot2)
#(plyr)
library(ppcor)
library(tidyverse)
# library(dplyr)
# library(tidyr)
library(stringr)
library(kableExtra)
# library(data.table)
# library(network)
# library(tidygraph)
# library(ggraph)
# library(igraph)
# library(networkD3)
# library(CINNA)
# library(umap)
# library(plotly)
#library(factoextra)
#library(lsr)
# library(car)
library(ggpubr)
#library(entropy)
#library(ds4psy)
# library(pROC)
#library(devtools)
#library(BRRR)
#library(stats)
#library(afex)
library(knitr)
library(janitor)
library(car)
library(ggiraph)
library(ggiraphExtra)
library(moonBook)
library(nationalparkcolors)
library(gridExtra)
library(markdown)
```

```{r, Functions, echo=FALSE, results='hide',message=FALSE}

ReadingCSVFunc <- function(pathname){
  
   #' @description: purpose of this is to read in CSVs and clean them up 
  #' @return: DF
  
  read.csv(paste0(working_dir, pathname), header=TRUE)

}

TableOutput <- function(df){
      knitr::kable(df, row.names=F) %>% kable_styling(bootstrap_options =  c("striped", "hover", "condensed")) %>% scroll_box(width = "600px", height = "300px")
    
  }

CleanDF <- function(DF,Variable){
  
  DF <- DF %>% select(-c("subject_id"))
  
  subinfo <- sub_info  %>% select(c("subject_id", "sex", "age_scan_years","repo_status",Variable))
  
  cleanedDF <- cbind(subinfo, DF) %>% drop_na()
  
  cleanedDF$sex[cleanedDF$sex=="Male"] <- 1 
  cleanedDF$sex[cleanedDF$sex=="Female"] <- 0
  cleanedDF$sex <- as.numeric(cleanedDF$sex)
  
    return (cleanedDF)
}


SelectAtlas <- function(Parcel,NetworkNum){
  #' @description: purpose of this is to read in and extract the ROIs from schaefer atlas you choose
  #' @return: A list of all the ROIs
  
  atlas_path <- ReadingCSVFunc(paste0("Schaefer2018_",Parcel,"Parcels_",NetworkNum, "Networks_order_FSLMNI152_1mm.Centroid_RAS.csv"))
  atlas_path$ROI.Name <- str_remove(atlas_path$ROI.Name,paste0(NetworkNum,"Networks_"))
  col_names <-c("subject_id",atlas_path$ROI.Name)
  
  return(col_names)
}

```

```{r reading in our CSVs, echo=FALSE, results='hide',message=FALSE}

working_dir <- "/Users/danielacossio/Documents/Chrastil_Lab/Projects/SNAG/Cortical_thickness/"
#working_dir <- "/Users/danielacossio/Library/CloudStorage/GoogleDrive-dcossio1@uci.edu/Other computers/My iMac/Chrastil_Lab/Projects/SNAG/Cortical_thickness/" # Laptop path

sub_info <- ReadingCSVFunc("subject_info.csv")%>% filter(!(subject_id %in% c("309", "341")))


CT_7network <- ReadingCSVFunc("master_CT400_parces7_networks.csv") %>% `colnames<-`(SelectAtlas(400,7)) %>%  arrange(subject_id) 

CT_17network <- ReadingCSVFunc("master_CT400_parces17_networks.csv") %>% `colnames<-`(SelectAtlas(400,17)) %>%  arrange(subject_id) 




```

<hr>

# Overview and Hypothesis 
Let's choose a few apriori regions to follow up with. In  this case, I believe we can go with the somatosensory motor L and R.

General approach : Do correlation between each parcellation and variable and then average by network. 

<hr>

# Path integration results 


## Degrees Traveled {.tabset .tabset-dropdown} 
### Average {.tabset .tabset-pills} 

<hr>

## Angular error {.tabset .tabset-dropdown} 
### Average {.tabset .tabset-pills} 
#### All
```{r,echo=FALSE, results='hide',message=FALSE}

M_AE_ave_df <- CleanDF(CT_7network,"loop_ae_avg_degree") %>% filter(sex==1)


```

```{r, echo=FALSE, results='hide',message=FALSE,fig.show='hide'}

df <-CleanDF(CT_7network,"loop_ae_avg_degree")

ROIs <- SelectAtlas(400,7) %>% .[-1] # removing sibject ID

plist <- list()

for (ROI in ROIs) {
  print(ROI)
  plist[[ROI]] <- ggplot(df, aes(x=loop_ae_avg_degree, y=.data[[ROI]]))  +
   geom_point(color="#502E23", size=4) +
   geom_smooth(method="lm", level=0.95,color ="#E2929D", se=FALSE,linewidth=2) +
    theme_classic() +
   labs(x ="Cortical Thickness", y = "Position Error", title = ROI) +
   theme( axis.title.x = element_text(vjust = -4,size = 16),
      axis.text.x = element_text(size = 25),
      axis.text.y = element_text(size = 25),
      axis.title.y = element_text(vjust = 4, size = 16),
      plot.title = element_text(hjust = 0.5 ,size=16),
      panel.border = element_rect(fill=NA,color = "#502E23"),
      panel.background =element_blank(), 
      strip.text.x = element_text(
        size = 16,
        color = "black",
        face = "bold.italic"
      ),
      legend.position = "right")
      #legend.key.size = unit(2, 'cm'),
         #legend.title = element_text(size=18), #change legend title font size
         #legend.text = element_text(size=18),
      #plot.margin = margin(1, 1, 1, 1, "cm")) 


    #png(file = CleanCSVsfigpath,ROI,"_sexdiff_QA.png"))  #,".png"))
    #print(plist[[ROI]] )
    #dev.off()
}


```


Running partial correlations on our results using the 400 parcellation and 7 network. 
Out of the 400 parcellations, these are the ones that were significant. Uncorrected pvalue. 

##### 7 network 

```{r, Partial correlations with average, echo=FALSE, results='hide',message=FALSE}


df <-CleanDF(CT_7network,"loop_ae_avg_degree")
 ROIs<- SelectAtlas(400,7) %>% .[-1] 
WholeBrain_7network400parc <- list()

cols <- 
sigWB_7network400parc <-data.frame(matrix(nrow=0,ncol=7)) %>% `colnames<-`(c("roi", "estimate" ,"p.value","statistic","n","gp","Method"))

for (ROI in ROIs) {
    WholeBrain_7network400parc[[ROI]] <- pcor.test(x=df["loop_ae_avg_degree"],y=df[[ROI]],z= df[,c("age_scan_years", "sex")])
    
    if (WholeBrain_7network400parc[[ROI]][["p.value"]] < 0.05){
      temp <-cbind(ROI,WholeBrain_7network400parc[[ROI]])
      
      sigWB_7network400parc <- rbind(sigWB_7network400parc,temp)
      
    }
  
}

```

```{r,echo=FALSE,message=FALSE}
TableOutput(sigWB_7network400parc)
```

<br>

```{r, echo=FALSE, results='hide',message=FALSE}

ROIs<- c(sigWB_7network400parc$ROI)  # removing sibject ID

plotlist <- list()

for (ROI in ROIs) {
  print(ROI)
  plotlist[[ROI]] <- ggplot(df, aes(x=loop_ae_avg_degree, y=.data[[ROI]]))  +
   geom_point(color="#502E23", size=4) +
   geom_smooth(method="lm", level=0.95,color ="#E2929D", se=FALSE,linewidth=2) +
    theme_classic() +
   labs(x ="Cortical Thickness", y = "Position Error", title = ROI) +
   theme( axis.title.x = element_text(vjust = -4), 
          plot.margin = margin(1, 1, 1, 1, "cm")) +
   #    axis.text.x = element_text(size = 25),
   #    axis.text.y = element_text(size = 25),
   #    axis.title.y = element_text(vjust = 4, size = 16),
   #    plot.title = element_text(hjust = 0.5 ,size=16),
   #    panel.border = element_rect(fill=NA,color = "#502E23"),
   #    panel.background =element_blank(), 
   #    strip.text.x = element_text(
   #      size = 16,
   #      color = "black",
   #      face = "bold.italic"
   #    ),
      # legend.position = "right")+
    stat_cor( method = "pearson", label.x.npc = "center",
  label.y.npc = "top")
      #legend.key.size = unit(2, 'cm'),
         #legend.title = element_text(size=18), #change legend title font size
         #legend.text = element_text(size=18),
     


    #png(file = CleanCSVsfigpath,ROI,"_sexdiff_QA.png"))  #,".png"))
    #print(plotlist[[ROI]] )
    #dev.off()
}


```

```{r,echo=FALSE, warning=FALSE,message=FALSE, fig.width=16, fig.height=24}
grid.arrange(plotlist[[1]],plotlist[[2]],plotlist[[3]], plotlist[[4]], plotlist[[5]],plotlist[[6]], plotlist[[7]], plotlist[[8]],plotlist[[9]],plotlist[[10]],plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],plotlist[[16]],plotlist[[17]],plotlist[[18]],nrow=6)
```


##### 17 network 

```{r, 17 netowrk Partial correlations with average, echo=FALSE, results='hide',message=FALSE, fig.show='hide'}

WholeBrain_17network400parc <- list()

ROIs<- SelectAtlas(400,17) %>% .[-1] 
cols <- 
sigWB_17network400parc <-data.frame(matrix(nrow=0,ncol=7)) %>% `colnames<-`(c("roi", "estimate" ,"p.value","statistic","n","gp","Method"))

df <-CleanDF(CT_17network,"loop_ae_avg_degree")

for (ROI in ROIs) {
    WholeBrain_17network400parc[[ROI]] <- pcor.test(x=df["loop_ae_avg_degree"],y=df[[ROI]],z= df[,c("age_scan_years", "sex")])
    
    if (WholeBrain_17network400parc[[ROI]][["p.value"]] < 0.05){
      temp <-cbind(ROI,WholeBrain_17network400parc[[ROI]])
      
      sigWB_17network400parc <- rbind(sigWB_17network400parc,temp)
      
    }
  
}

```

```{r,echo=FALSE,message=FALSE}
TableOutput(sigWB_17network400parc)
```

<br>

```{r, echo=FALSE, results='hide',message=FALSE,fig.show='hide'}

ROIs<- c(sigWB_17network400parc$ROI)  # removing sibject ID

plotlist <- list()

for (ROI in ROIs) {
  print(ROI)
  plotlist[[ROI]] <- ggplot(df, aes(x=loop_ae_avg_degree, y=.data[[ROI]]))  +
   geom_point(color="#502E23", size=4) +
   geom_smooth(method="lm", level=0.95,color ="#E2929D", se=FALSE,linewidth=2) +
    theme_classic() +
   labs(x ="Cortical Thickness", y = "Position Error", title = ROI) +
   theme( axis.title.x = element_text(vjust = -4), 
          plot.margin = margin(1, 1, 1, 1, "cm")) +
   #    axis.text.x = element_text(size = 25),
   #    axis.text.y = element_text(size = 25),
   #    axis.title.y = element_text(vjust = 4, size = 16),
   #    plot.title = element_text(hjust = 0.5 ,size=16),
   #    panel.border = element_rect(fill=NA,color = "#502E23"),
   #    panel.background =element_blank(), 
   #    strip.text.x = element_text(
   #      size = 16,
   #      color = "black",
   #      face = "bold.italic"
   #    ),
      # legend.position = "right")+
    stat_cor( method = "pearson", label.x.npc = "center",
  label.y.npc = "top")
      #legend.key.size = unit(2, 'cm'),
         #legend.title = element_text(size=18), #change legend title font size
         #legend.text = element_text(size=18),
     


    #png(file = CleanCSVsfigpath,ROI,"_sexdiff_QA.png"))  #,".png"))
    #print(plotlist[[ROI]] )
    #dev.off()
}


```

```{r,echo=FALSE, warning=FALSE,message=FALSE, fig.width=16, fig.height=24}
grid.arrange(plotlist[[1]],plotlist[[2]],plotlist[[3]], plotlist[[4]], plotlist[[5]],plotlist[[6]], plotlist[[7]], plotlist[[8]],plotlist[[9]],plotlist[[10]],plotlist[[11]],plotlist[[12]],plotlist[[13]],plotlist[[14]],plotlist[[15]],plotlist[[16]],plotlist[[17]],plotlist[[18]],nrow=6)
```

#### Female 
##### 7 netw=ork
```{r, Partial correlations with average, echo=FALSE, results='hide',message=FALSE}

df <- CleanDF(CT_7network,"loop_ae_avg_degree") %>% filter(sex==0)

ROIs<- SelectAtlas(400,7) %>% .[-1] 
fem_7network400parc <- list()

cols <- 
sigWB_7network400parc <-data.frame(matrix(nrow=0,ncol=7)) %>% `colnames<-`(c("roi", "estimate" ,"p.value","statistic","n","gp","Method"))

for (ROI in ROIs) {
    WholeBrain_7network400parc[[ROI]] <- pcor.test(x=df["loop_ae_avg_degree"],y=df[[ROI]],z= df[,c("age_scan_years", "sex")])
    
    if (WholeBrain_7network400parc[[ROI]][["p.value"]] < 0.05){
      temp <-cbind(ROI,WholeBrain_7network400parc[[ROI]])
      
      sigWB_7network400parc <- rbind(sigWB_7network400parc,temp)
      
    }
  
}

```

```{r,echo=FALSE,message=FALSE}
TableOutput(sigWB_7network400parc)
```

#### Male 
# ROIs


